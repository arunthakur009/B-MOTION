<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brownian-Motion TRNG</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=10">
</head>

<body>

    <!-- Header -->
    <header class="header">
        <div class="brand">
            <span class="brand-title">Brownian-Motion TRNG</span>
            <span class="brand-tagline">True Randomness Powered by Physical Entropy</span>
        </div>
        <div class="controls">
            <!-- Search icon placeholder could go here -->
            <button class="btn-threat" id="btn-activate-threat" onclick="toggleThreatMode()">ACTIVATE THREAT
                MODE</button>
        </div>
    </header>

    <!-- Nav Banner -->
    <nav class="nav-banner">
        <a href="#" class="nav-link active">DASHBOARD</a>
    </nav>

    <!-- Main Content Grid -->
    <main class="dashboard-grid">

        <!-- Top Left: Live Feed with Tabs -->
        <div class="widget widget-dark">
            <div
                style="padding: 8px 12px; display: flex; gap: 6px; border-bottom: 1px solid var(--border-dark); background: rgba(0,0,0,0.2);">
                <button class="feed-tab active" onclick="switchFeedTab('camera', this)">CAMERA</button>
                <button class="feed-tab" onclick="switchFeedTab('heatmap', this)">HEATMAP</button>
                <button class="feed-tab" onclick="switchFeedTab('particle', this)">PARTICLE</button>
            </div>
            <div class="video-container">
                <img id="live-feed-img" src="{{ url_for('video_feed') }}" alt="Live Camera Feed">
                <div class="live-badge" id="live-badge-text">LIVE CAMERA FEED</div>
            </div>
            <div
                style="padding: 10px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #333;">
                <span class="stat-label">Camera Status: <span style="color: var(--success);">ACTIVE</span></span>
                <span class="stat-label">Res: 640x480</span>
            </div>
        </div>

        <!-- Top Right: Stochastic Path Trace (Hybrid) -->
        <div class="widget widget-light">
            <div class="widget-hybrid-header">
                <div class="widget-title">
                    <span>STOCHASTIC PATH TRACE</span>
                    <!-- Attack Simulation Toggle in header -->
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 0.7rem; color: #718096; font-weight: 700;">ATTACK SIMULATION MODE</span>
                        <label class="switch">
                            <input type="checkbox" id="attack-toggle" onchange="toggleAttackMenu(this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <!-- Controls for types of attacks (hidden by default or shown when toggle is ON) -->
                <div id="attack-controls" style="display: none; gap: 10px; margin-top: 10px;">
                    <button class="btn-threat" style="font-size: 0.7rem; padding: 4px 8px;"
                        onclick="setAttack('FREEZE')">FREEZE</button>
                    <button class="btn-threat" style="font-size: 0.7rem; padding: 4px 8px;"
                        onclick="setAttack('BRIGHTNESS')">BRIGHTNESS</button>
                    <button class="btn-threat" style="font-size: 0.7rem; padding: 4px 8px;"
                        onclick="setAttack('PATTERN')">PATTERN</button>
                    <button class="btn-threat" style="font-size: 0.7rem; padding: 4px 8px;" id="btn-drbg"
                        onclick="toggleDRBG(this)">DRBG FALLBACK</button>
                    <button class="btn-threat"
                        style="font-size: 0.7rem; padding: 4px 8px; border-color: #666; color: #666;"
                        onclick="setAttack('NONE')">RESET</button>
                </div>
            </div>
            <div class="widget-hybrid-body"
                style="background: #fff; display: flex; justify-content: center; align-items: center; padding: 0;">
                <!-- Particle Feed -->
                <img src="{{ url_for('particle_feed') }}" style="width: 100%; height: 250px; object-fit: contain;"
                    alt="Particle Path Trace">
            </div>
        </div>

        <!-- Mid Left: Entropy Per Frame (Light) -->
        <div class="widget widget-light">
            <div style="padding: 1rem;">
                <div class="widget-title">ENTROPY PER FRAME</div>
                <div style="height: 200px; width: 100%;">
                    <canvas id="entropyBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Mid Right: Statistical Tests (Light) -->
        <div class="widget widget-light"
            style="padding: 1.5rem; display: flex; flex-direction: row; gap: 2rem; align-items: center;">

            <!-- Gauge -->
            <div style="position: relative; width: 150px; height: 150px;">
                <canvas id="qualityGauge"></canvas>
                <div id="gauge-text"
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div id="gauge-score" style="font-size: 1.8rem; font-weight: 800; color: var(--text-primary);">95
                    </div>
                    <div
                        style="font-size: 0.65rem; color: var(--text-tertiary); font-weight: 600; letter-spacing: 0.5px;">
                        CONFIDENCE</div>
                </div>
            </div>

            <!-- Stats List -->
            <div class="stats-list" style="flex-grow: 1;">
                <div class="widget-title" style="margin-bottom: 15px;">STATISTICAL TESTS</div>
                <div class="stat-item">
                    <span class="stat-label">Shannon Entropy</span>
                    <span class="stat-value" id="val-shannon">-- / 8 bits</span>
                </div>
                <!-- ... other stats ... -->
                <div class="stat-item">
                    <span class="stat-label">Min Entropy</span>
                    <span class="stat-value" id="val-min">-- / bit</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Autocorrelation</span>
                    <span class="stat-value" id="val-auto">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Bit Rate</span>
                    <span class="stat-value" id="val-bitrate">-- bps</span>
                </div>
                <div class="stat-item" style="margin-top: 10px;">
                    <span class="stat-label">Overall Health</span>
                    <span class="stat-value" id="val-health" style="color: var(--success);">HEALTHY</span>
                </div>
            </div>
        </div>

        <!-- Bottom Left: Mean Squared Displacement (Hybrid) -->
        <div class="widget widget-light" style="grid-column: span 2;">
            <div class="widget-hybrid-header">
                <div class="widget-title">BROWNIAN MOTION DYNAMICS (MSD)</div>
            </div>
            <div class="widget-hybrid-body" style="background: #fff; height: 200px;">
                <canvas id="msdChart"></canvas>
            </div>
        </div>

        <!-- Key Display Banner -->
        <div class="key-banner">
            <div class="key-title">MASTER WI-FI KEY (SHA-256 + CHACHA20)</div>
            <div class="master-key" id="key-display">INITIALIZING...</div>
        </div>

        <!-- Footer Progress -->
        <div class="footer-panel">
            <div class="progress-label">
                <span>30-Second Rotation Cycle</span>
                <span id="timer-text">30s</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="cycle-progress"></div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-threat" style="background: transparent; color: #718096; border-color: #cbd5e0;"
                    onclick="runComparison(this)">RUN NIST COMPARATIVE ANALYSIS</button>
            </div>
            <!-- Hidden Table for NIST results to popup or appear -->
            <div id="nist-results" style="margin-top: 20px; display: none;">
                <!-- Populated by JS -->
            </div>
        </div>

    </main>

    <script src="{{ url_for('static', filename='js/charts.js') }}?v=10"></script>
</body>

</html>